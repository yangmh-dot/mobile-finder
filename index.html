<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI å½±ç‰‡æœå°‹å™¨</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#3b82f6">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #f9fafc; color: #1f2937; font-family: 'Inter', system-ui, -apple-system, "Noto Sans TC", "PingFang TC", sans-serif; }
    header { border-bottom: 3px solid #3b82f6; background: white; position: sticky; top: 0; z-index: 20; }
    .card { background: white; border: 1px solid #cfe1ff; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .btn { background: #3b82f6; color: white; border-radius: 0.6rem; padding: 0.55rem 1rem; font-weight: 600; }
    .btn:hover { background: #2563eb; }
    .btn-alt { background: #e5e7eb; color: #1f2937; }
    select, input { border: 1px solid #93c5fd; border-radius: 0.6rem; padding: 0.5rem 0.7rem; }
    #results img, #results video { border-radius: 0.6rem; }
    .badge { font-size: 12px; padding: 2px 8px; border: 1px solid #93c5fd; border-radius: 999px; color: #1f2937; background: #eef5ff; }
    .ghost { opacity: .7; }
  </style>
</head>
<body>
<header class="px-4 py-3 flex justify-between items-center">
  <div class="text-lg md:text-xl font-bold text-blue-700">ğŸ“¸ AI å½±ç‰‡æœå°‹å™¨</div>
  <button id="btnSettings" class="text-blue-600 font-semibold">âš™ï¸ Settings</button>
</header>

<main class="max-w-6xl mx-auto p-4 space-y-4">
  <!-- Search Controls -->
  <section class="card p-4 rounded-xl">
    <h2 class="text-lg font-semibold mb-2 text-blue-700">æœå°‹è¨­å®š / Search Settings</h2>
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
      <div><label class="text-sm">Country åœ‹å®¶</label><select id="country" class="w-full"></select></div>
      <div><label class="text-sm">City åŸå¸‚</label><select id="city" class="w-full"></select></div>
      <div><label class="text-sm">Place åœ°é»</label>
        <select id="place" class="w-full">
          <option>Any</option><option>Landmark</option><option>Beach</option>
          <option>Park</option><option>Temple</option><option>CafÃ©</option><option>Street</option>
        </select></div>
      <div><label class="text-sm">Theme ä¸»é¡Œ</label><select id="theme" class="w-full"></select></div>
      <div class="lg:col-span-2"><label class="text-sm">Keywords é—œéµå­—</label><input id="keywords" class="w-full" placeholder="sunset, skyline, cat"></div>
      <div><label class="text-sm">Mode æ¨¡å¼</label>
        <div class="flex gap-2">
          <button id="modeImages" class="btn bg-blue-600 flex-1">ğŸ“· Images</button>
          <button id="modeVideos" class="btn btn-alt flex-1 text-blue-700 border border-blue-300">ğŸ¥ Videos</button>
        </div>
      </div>
      <div class="flex items-end gap-2">
        <button id="btnSearch" class="btn">ğŸ” Search</button>
        <button id="btnClear" class="btn btn-alt">Clear</button>
        <button id="btnGenerate" class="btn bg-green-500">âœ¨ Generate Titles</button>
      </div>
    </div>
  </section>

  <!-- Tips (hidden by default; you can toggle display:block via dev tools if ever needed) -->
  <div id="tip" class="hidden text-sm text-blue-700">ğŸ“· ä½¿ç”¨ Wikimedia / ğŸ¥ ä½¿ç”¨ Pexelsï¼ˆéœ€ API Keyï¼‰</div>

  <!-- Results -->
  <div id="loading" class="text-center text-blue-600 hidden">â³ Loading...</div>
  <section id="results" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4"></section>
  <div class="flex justify-center">
    <button id="btnMore" class="btn hidden">Load More</button>
  </div>

  <!-- Copy toast -->
  <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-6 bg-black text-white px-3 py-2 rounded-lg text-sm hidden">å·²è¤‡è£½é€£çµ</div>

  <!-- Titles -->
  <div id="output" class="card p-4 rounded-xl hidden">
    <h3 class="text-blue-700 font-semibold mb-2">ğŸ¬ AI å½±ç‰‡æ¨™é¡Œèˆ‡æè¿°ç”Ÿæˆ / Title & Description</h3>
    <div class="flex gap-2 mb-2 flex-wrap">
      <button class="btn bg-blue-500" data-mode="cinematic">Cinematic</button>
      <button class="btn bg-purple-500" data-mode="seo">SEO</button>
      <button class="btn bg-pink-500" data-mode="clickbait">Clickbait</button>
      <button id="btnCopyText" class="btn btn-alt text-blue-700 border border-blue-300">ğŸ“„ Copy Text</button>
    </div>
    <pre id="textOutput" class="whitespace-pre-wrap text-sm"></pre>
  </div>
</main>

<!-- Settings Modal -->
<div id="settingsModal" class="hidden fixed inset-0 bg-black/50 flex justify-center items-center z-50">
  <div class="bg-white p-5 rounded-xl w-[92vw] max-w-md">
    <h3 class="text-blue-700 font-semibold mb-2">âš™ï¸ API è¨­å®š</h3>
    <p class="text-sm mb-2">è¼¸å…¥ä½ çš„ Pexels API Keyï¼ˆé¸å¡«ï¼Œç”¨æ–¼åœ–ç‰‡èˆ‡å½±ç‰‡æœå°‹ï¼‰ï¼š</p>
    <input id="pexelsKey" type="text" placeholder="Pexels API Key" class="w-full border p-2 mb-3 rounded">
    <div class="flex justify-end gap-2">
      <button id="btnSaveKey" class="btn">Save</button>
      <button id="btnCloseSettings" class="btn btn-alt">Close</button>
    </div>
  </div>
</div>

<script>
/* =======================
   Data (Countries / Cities / Themes / Place mapping)
======================= */
const DATA = {
  "Any": ["Any"],

  // United States + Asia focus
  "United States": [
    "Any",
    "New York","Los Angeles","San Francisco","Chicago","Seattle","Las Vegas","Miami",
    "Washington D.C.","Boston","Philadelphia","Houston","Dallas","Austin","Denver",
    "Portland","San Diego","Phoenix","Orlando","Atlanta","Honolulu","New Orleans"
  ],
  "Japan": [
    "Any","Tokyo","Kyoto","Osaka","Yokohama","Sapporo","Nagoya","Kobe","Hiroshima","Fukuoka","Okinawa","Nara"
  ],
  "Taiwan": [
    "Any","Taipei","New Taipei","Taoyuan","Taichung","Tainan","Kaohsiung","Hualien","Yilan","Taitung","Chiayi"
  ],
  "South Korea": [
    "Any","Seoul","Busan","Incheon","Daegu","Daejeon","Gwangju","Suwon","Jeju"
  ],
  "Thailand": [
    "Any","Bangkok","Chiang Mai","Phuket","Pattaya","Krabi","Ayutthaya","Hua Hin","Chiang Rai"
  ],
  "Indonesia": [
    "Any","Jakarta","Bali","Bandung","Yogyakarta","Surabaya","Medan","Lombok","Makassar"
  ],
  "Vietnam": [
    "Any","Ho Chi Minh City","Hanoi","Da Nang","Hoi An","Nha Trang","Hue","Phu Quoc"
  ],
  "Philippines": [
    "Any","Manila","Quezon City","Cebu","Davao","Baguio","Boracay","Palawan"
  ],
  "Malaysia": [
    "Any","Kuala Lumpur","George Town","Malacca","Kota Kinabalu","Johor Bahru","Langkawi","Ipoh"
  ],
  "Singapore": [
    "Any","Downtown","Marina Bay","Sentosa","Chinatown","Little India","Orchard"
  ]
};

const THEMES = [
  "Any","Animals","Nature","Architecture","Food","People","Night View",
  "Beach & Ocean","City Streets","Countryside","Mountains","Festivals",
  "Sports","Transportation","CafÃ© / Lifestyle","Technology / Modern","Sunrise / Sunset"
];

// Optional query enrichment for Place
const PLACE_MAP = {
  "Any": "", "Landmark": "landmark", "Beach": "beach coast ocean",
  "Park": "park garden", "Temple": "temple shrine", "CafÃ©": "cafe coffee",
  "Street": "street city"
};

/* =======================
   Elements & State
======================= */
const country = document.getElementById("country");
const city = document.getElementById("city");
const place = document.getElementById("place");
const theme = document.getElementById("theme");
const keywords = document.getElementById("keywords");
const results = document.getElementById("results");
const loading = document.getElementById("loading");
const btnMore = document.getElementById("btnMore");
const toast = document.getElementById("toast");

const modeImages = document.getElementById("modeImages");
const modeVideos = document.getElementById("modeVideos");
let searchMode = "images";          // "images" | "videos"
const PAGE_SIZE = 12;

// Wikimedia pagination
let wikiContinue = null;
// Pexels pagination
let pexelsPage = 1;

/* =======================
   Init Selects
======================= */
for (const c of Object.keys(DATA)) {
  const opt = document.createElement("option");
  opt.textContent = c;
  country.appendChild(opt);
}
for (const t of THEMES) {
  const opt = document.createElement("option");
  opt.textContent = t;
  theme.appendChild(opt);
}
function populateCities() {
  city.innerHTML = "";
  (DATA[country.value] || ["Any"]).forEach(x => {
    const o = document.createElement("option");
    o.textContent = x;
    city.appendChild(o);
  });
}
country.addEventListener("change", populateCities);
populateCities();

/* =======================
   Helpers
======================= */
function buildQuery() {
  const parts = [];
  if (country.value !== "Any") parts.push(country.value);
  if (city.value !== "Any") parts.push(city.value);
  const pm = PLACE_MAP[place.value] || "";
  if (pm) parts.push(pm);
  if (theme.value !== "Any") parts.push(theme.value);
  if (keywords.value.trim()) parts.push(keywords.value.trim());
  return parts.join(" ").trim() || "travel";
}

async function copyText(text) {
  try {
    await navigator.clipboard.writeText(text);
    toast.textContent = "å·²è¤‡è£½é€£çµ";
    toast.classList.remove("hidden");
    setTimeout(()=>toast.classList.add("hidden"), 1200);
  } catch(e) {
    alert(text); // fallback
  }
}

function fmtDuration(sec) {
  if (!sec && sec !== 0) return "";
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  if (m <= 0) return `${s}s`;
  return `${m}m ${s}s`;
}

function cardImage({thumb, url, title="Open image"}) {
  return `
    <div class="card p-2 rounded-xl">
      <a href="${url}" target="_blank" rel="noopener">
        <img src="${thumb}" alt="${title}" class="w-full object-cover aspect-[4/3]">
      </a>
      <div class="flex items-center justify-between gap-2 mt-2">
        <span class="badge">Image</span>
        <button class="btn btn-alt text-blue-700 border border-blue-300 text-sm px-3 py-1" data-copy="${url}">ğŸ“„ Copy Link</button>
      </div>
    </div>`;
}

function cardVideo({thumb, url, duration}) {
  const dur = fmtDuration(duration);
  return `
    <div class="card p-2 rounded-xl">
      <video src="${url}" poster="${thumb||''}" controls class="w-full aspect-video rounded"></video>
      <div class="flex items-center justify-between gap-2 mt-2">
        <span class="badge">Video ${dur ? `Â· ${dur}` : ""}</span>
        <button class="btn btn-alt text-blue-700 border border-blue-300 text-sm px-3 py-1" data-copy="${url}">ğŸ“„ Copy Link</button>
      </div>
    </div>`;
}

function bindCopyButtons(scope=document) {
  scope.querySelectorAll("button[data-copy]").forEach(b=>{
    b.addEventListener("click", ()=> copyText(b.getAttribute("data-copy")));
  });
}

/* =======================
   Search Implementations
======================= */
async function searchWikimedia(reset=false) {
  if (reset) {
    wikiContinue = null;
    results.innerHTML = "";
  }
  const q = buildQuery();
  const params = new URLSearchParams({
    action: "query",
    format: "json",
    origin: "*",
    generator: "search",
    gsrsearch: q,
    gsrlimit: PAGE_SIZE.toString(),
    prop: "imageinfo",
    iiprop: "url"
  });
  if (wikiContinue) {
    for (const [k, v] of Object.entries(wikiContinue)) params.set(k, v);
  }
  const api = "https://commons.wikimedia.org/w/api.php?" + params.toString();
  const resp = await fetch(api);
  const data = await resp.json();
  const pages = data.query?.pages || {};
  const arr = Object.values(pages);
  const frag = document.createElement("div");
  arr.forEach(p=>{
    const url = p.imageinfo?.[0]?.url;
    if (url) frag.insertAdjacentHTML("beforeend", cardImage({thumb:url, url}));
  });
  results.appendChild(frag);
  wikiContinue = data.continue || null;
  btnMore.classList.toggle("hidden", !wikiContinue);
  bindCopyButtons(results);
}

async function searchPexelsPhotos(key, reset=false) {
  if (reset) {
    pexelsPage = 1;
    results.innerHTML = "";
  }
  const q = buildQuery();
  const url = `https://api.pexels.com/v1/search?query=${encodeURIComponent(q)}&per_page=${PAGE_SIZE}&page=${pexelsPage}`;
  const resp = await fetch(url, { headers: { Authorization: key }});
  const data = await resp.json();
  const list = (data.photos || []).map(p=>({thumb: p.src?.medium || p.src?.small, url: p.src?.original }));
  const frag = document.createElement("div");
  list.forEach(i=> frag.insertAdjacentHTML("beforeend", cardImage(i)));
  results.appendChild(frag);
  bindCopyButtons(results);
  // next page
  const hasMore = (data.photos || []).length === PAGE_SIZE;
  pexelsPage += 1;
  btnMore.classList.toggle("hidden", !hasMore);
}

async function searchPexelsVideos(key, reset=false) {
  if (reset) {
    pexelsPage = 1;
    results.innerHTML = "";
  }
  const q = buildQuery();
  const url = `https://api.pexels.com/videos/search?query=${encodeURIComponent(q)}&per_page=${PAGE_SIZE}&page=${pexelsPage}`;
  const resp = await fetch(url, { headers: { Authorization: key }});
  const data = await resp.json();
  const vids = (data.videos || []).map(v=>{
    const file = (v.video_files||[]).sort((a,b)=> (b.width*b.height)-(a.width*a.height))[0] || v.video_files?.[0];
    const url  = file?.link || v.url;
    const thumb = v.video_pictures?.[0]?.picture || v.image;
    return {thumb, url, duration: v.duration};
  });
  const frag = document.createElement("div");
  vids.forEach(v=> frag.insertAdjacentHTML("beforeend", cardVideo(v)));
  results.appendChild(frag);
  bindCopyButtons(results);
  const hasMore = (data.videos || []).length === PAGE_SIZE;
  pexelsPage += 1;
  btnMore.classList.toggle("hidden", !hasMore);
}

/* =======================
   UI Events
======================= */
const btnSearch = document.getElementById("btnSearch");
const btnClear  = document.getElementById("btnClear");

modeImages.addEventListener("click", ()=>{
  searchMode = "images";
  modeImages.classList.remove("btn-alt"); modeImages.classList.add("bg-blue-600", "text-white");
  modeVideos.classList.add("btn-alt"); modeVideos.classList.remove("bg-blue-600","text-white");
});
modeVideos.addEventListener("click", ()=>{
  searchMode = "videos";
  modeVideos.classList.remove("btn-alt"); modeVideos.classList.add("bg-blue-600", "text-white");
  modeImages.classList.add("btn-alt"); modeImages.classList.remove("bg-blue-600","text-white");
});

btnSearch.addEventListener("click", async ()=>{
  results.innerHTML = "";
  btnMore.classList.add("hidden");
  wikiContinue = null; pexelsPage = 1;
  loading.classList.remove("hidden");
  const key = localStorage.getItem("pexelsKey") || "";

  try {
    if (searchMode === "videos") {
      if (!key) {
        results.innerHTML = `<div class="card p-4 rounded-xl">
          <div class="text-red-600 font-semibold mb-1">éœ€è¦ Pexels API Key æ‰èƒ½æœå°‹å½±ç‰‡</div>
          <div class="text-sm">è«‹é»å³ä¸Š <b>Settings</b> è²¼ä¸Šä½ çš„ Keyï¼Œæˆ–åˆ‡æ›åˆ° <span class="badge">Images</span> æ¨¡å¼ã€‚</div>
        </div>`;
        loading.classList.add("hidden");
        return;
      }
      await searchPexelsVideos(key, true);
    } else {
      // images
      if (key) {
        await searchPexelsPhotos(key, true);
      } else {
        await searchWikimedia(true);
      }
    }
  } catch (e) {
    console.error(e);
    results.innerHTML = `<p class="text-red-500">âŒ æœå°‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</p>`;
  } finally {
    loading.classList.add("hidden");
  }
});

btnMore.addEventListener("click", async ()=>{
  loading.classList.remove("hidden");
  const key = localStorage.getItem("pexelsKey") || "";
  try {
    if (searchMode === "videos") {
      await searchPexelsVideos(key, false);
    } else {
      if (key) await searchPexelsPhotos(key, false);
      else await searchWikimedia(false);
    }
  } catch(e) {
    console.error(e);
  } finally {
    loading.classList.add("hidden");
  }
});

btnClear.addEventListener("click", ()=>{
  results.innerHTML = "";
  btnMore.classList.add("hidden");
  keywords.value = "";
});

/* =======================
   Title Generator
======================= */
const output = document.getElementById("output");
const btnGenerate = document.getElementById("btnGenerate");
const textOutput = document.getElementById("textOutput");
const btnCopyText = document.getElementById("btnCopyText");

btnGenerate.addEventListener("click", ()=>{
  output.classList.remove("hidden");
  const q = buildQuery();
  function makeText(mode){
    if(mode==='cinematic')return `ğŸ¬ *Cinematic Title*\nEN: Journey Through ${q}\nZH: ${q} çš„é›»å½±æ„Ÿç•«é¢\n\nDescription:\nEN: A cinematic travel montage showcasing ${q} â€” natural light, soft motion, emotional storytelling.\nZH: ä¸€æ®µä»¥ ${q} ç‚ºä¸»é¡Œçš„é›»å½±æ„Ÿæ—…è¡Œå‰ªè¼¯ï¼ŒæŸ”å…‰æ…¢æ™¯ï¼Œæƒ…ç·’æ•˜äº‹ã€‚\n\nHashtags:\n#${q.replace(/\\s+/g,'#')} #cinematic #travel #shortfilm`;
    if(mode==='seo')return `ğŸ§­ *SEO Title*\nEN: Discover ${q} in 4K â€“ Travel Highlights\nZH: æ¢ç´¢ ${q} çš„æ—…éŠäº®é» 4K å½±ç‰‡\n\nDescription:\nEN: Explore the best of ${q}, including landmarks, food, and local culture.\nZH: ç²¾é¸ ${q} çš„æ™¯é»ã€ç¾é£Ÿèˆ‡äººæ–‡ï¼Œçµ¦æ—…äººçš„å¿«é€Ÿå°è¦½ã€‚\n\nHashtags:\n#${q.replace(/\\s+/g,'#')} #travelguide #explore #4k`;
    if(mode==='clickbait')return `ğŸ˜‚ *Clickbait Title*\nEN: You Wonâ€™t Believe What Happened in ${q}!\nZH: ${q} ç™¼ç”Ÿçš„äº‹ä½ çµ•å°æƒ³ä¸åˆ°ï¼\n\nDescription:\nEN: Funny, surprising, and heartwarming clips filmed around ${q}.\nZH: é›†åˆ ${q} çš„é©šå–œèˆ‡è¶£å‘³ç‰‡æ®µï¼Œè¶…é©åˆ Shortsã€‚\n\nHashtags:\n#${q.replace(/\\s+/g,'#')} #funny #shorts #viral`;
  }
  textOutput.textContent = makeText('cinematic');
  output.querySelectorAll('button[data-mode]').forEach(b=>{
    b.addEventListener('click', ()=> textOutput.textContent = makeText(b.dataset.mode));
  });
});
btnCopyText.addEventListener("click", ()=> copyText(textOutput.textContent));

/* =======================
   Settings (API Key)
======================= */
const modal = document.getElementById("settingsModal");
const btnSettings = document.getElementById("btnSettings");
const btnClose = document.getElementById("btnCloseSettings");
const btnSave = document.getElementById("btnSaveKey");
const pexelsKeyInput = document.getElementById("pexelsKey");

btnSettings.onclick = ()=>{
  pexelsKeyInput.value = localStorage.getItem("pexelsKey") || "";
  modal.classList.remove("hidden");
};
btnClose.onclick = ()=> modal.classList.add("hidden");
btnSave.onclick = ()=>{
  localStorage.setItem("pexelsKey", (pexelsKeyInput.value||"").trim());
  alert("âœ… å·²å„²å­˜ API Key");
  modal.classList.add("hidden");
};

/* =======================
   Service Worker
======================= */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js")
    .then(()=>console.log("SW ok"))
    .catch(e=>console.error("SW fail", e));
}
</script>
</body>
</html>
